- name: install lxd
  become: yes
  snap:
    name: lxd
  register: result
- when: result.changed
  shell: "{{item}}"
  loop:
    - 'lxd init --auto'
- shell: "{{item}}"
  loop:
    - 'lxc config set core.https_address "[::]"'
    - 'lxc config set core.trust_password xyz'
- when: result.changed
  delegate_to: localhost
  shell: lxc remote add {{inventory_hostname}} {{inventory_hostname}} --password xyz --accept-certificate 

- name: create profile
  community.general.lxd_profile:
    name: bridge
    state: present
    config:
      limits.cpu: "1"
      limits.memory: "2GiB"
    devices:
      eth0:
        nictype: bridged
        parent: br0
        type: nic

- name: deploy VMs
  community.general.lxd_container:
    name: "{{item}}"
    type: virtual-machine
    ignore_volatile_options: true
    state: started
    source:
      type: image
      moode: pull
      alias: ubuntu/20.04
      server: https://images.linuxcontainers.org
      protocol: simplestreams
    profiles: ["default","bridge"]
    wait_for_ipv4_addresses: true
  loop: "{{groups['vms']}}"
  when:
    - hostvars[item].ansible_host is match('^'+inventory_hostname+':'+item+'$')

