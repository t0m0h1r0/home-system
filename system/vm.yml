- hosts: servers
  become: yes
  vars:
    nic: "{{hostvars[inventory_hostname].nic}}"
  tasks:
    - import_tasks: 01_config_network.yml
  handlers:
    - import_tasks: 01_apply_config.yml

- hosts: servers
  tasks:
    - import_tasks: 09_deploy_vms.yml 
- hosts: registry
  become: yes
  vars:
    apt_apps:
      - docker.io
      - docker-compose
      - python3-docker
    snap_apps:
    pvs:
      - { "name": "docker_dir", "dir": "/var/lib/docker" }
  tasks:
    - import_tasks: 02_install_apps.yml
    - import_tasks: 06_config_docker.yml
    - import_tasks: 08_config_registry.yml

- hosts: workers managers
  become: yes
  vars:
    apt_proxy: "{{groups['registry'][0]}}"
    apt_apps:
      - docker.io
      - docker-compose
      - python3-docker
    snap_apps:
  tasks:
    - import_tasks: 02_install_apps.yml
    - import_tasks: 06_config_docker.yml

- hosts: storages
  become: yes
  vars:
    mount_point: /mnt/iscsi
    iscsi_list:
      - portal: syn1
        target: iqn.2000-01.com.synology:syn1.Target-1.9c3409d65fa
        uuid: 5ef36ece-6516-4100-b92d-089e66cb9ad9
      - portal: readynas
        target: iqn.1994-11.com.netgear:readynas:b6aca745:group1
        uuid: be26ee1b-c979-4e5b-9cc8-7cef967195a7
    iscsi: "{{dict(ansible_play_batch|zip_longest(iscsi_list,fillvalue=iscsi_list[0]))}}"
  tasks:
    - import_tasks: 05_config_iscsi.yml

- hosts: workers managers
  become: yes
  vars:
    labels:
      managers:
        database: "true"
        grafana: "true"
        ldap: "true"
        portainer: "true"
      storages:
        storage: "true"
      computes:
        compute: "true"
  tasks:
    - import_tasks: 07_config_swarm.yml
